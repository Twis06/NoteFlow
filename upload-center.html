<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä¸Šä¼ ä¸­å¿ƒ - AIé©±åŠ¨çš„æ–‡æ¡£å¤„ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2d3748;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background-color: #ebf4ff;
        }

        .upload-icon {
            font-size: 48px;
            color: #a0aec0;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #718096;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: #2d3748;
        }

        .file-size {
            font-size: 0.8rem;
            color: #718096;
        }

        .status-panel {
            grid-column: 1 / -1;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .status-item {
            text-align: center;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
        }

        .status-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .status-label {
            color: #4a5568;
            font-weight: 500;
        }

        .log-area {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .settings-panel {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* æ–‡ä»¶åˆ—è¡¨æ ·å¼ */
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }

        .file-name {
            font-weight: 500;
            color: #2d3748;
            flex: 1;
        }

        .file-size {
            color: #718096;
            font-size: 0.9em;
            margin-right: 12px;
        }

        .remove-btn {
            background: #f56565;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: background-color 0.2s;
        }

        .remove-btn:hover {
            background: #e53e3e;
        }

        /* æ‹–æ‹½æ ·å¼ */
        .drag-over {
            border-color: #4299e1 !important;
            background-color: #ebf8ff !important;
        }

        /* ç»“æœåŒºåŸŸæ ·å¼ */
        .result-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .result-header h4 {
            margin: 0;
            color: #2d3748;
            font-size: 1.1em;
        }

        .confidence {
            background: #48bb78;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .result-content {
            display: grid;
            gap: 16px;
        }

        .ocr-text, .markdown-content {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .ocr-text h5, .markdown-content h5 {
            margin: 0 0 12px 0;
            color: #4a5568;
            font-size: 0.95em;
            font-weight: 600;
        }

        .ocr-text p {
            margin: 0;
            color: #2d3748;
            line-height: 1.6;
        }

        .markdown-content pre {
            margin: 0;
            background: #2d3748;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.9em;
        }

        .no-results {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 40px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
        }

        .modal-header h3 {
            margin: 0;
            color: #2d3748;
        }

        .close-btn {
            background: #f56565;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: background-color 0.2s;
        }

        .close-btn:hover {
            background: #e53e3e;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .file-tree {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-tree-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .file-icon {
            margin-right: 12px;
            font-size: 1.2em;
        }

        .file-tree-item .file-name {
            flex: 1;
            font-weight: 500;
            color: #2d3748;
        }

        .file-tree-item .file-size {
            color: #718096;
            font-size: 0.9em;
        }

        /* æ¶ˆæ¯æç¤ºæ ·å¼ */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }

        .message-success {
            background: #48bb78;
        }

        .message-error {
            background: #f56565;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 15px;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
            }

            .result-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ æ™ºèƒ½ä¸Šä¼ ä¸­å¿ƒ</h1>
            <p>AIé©±åŠ¨çš„æ‰‹å†™æ–‡æ¡£å¤„ç†ä¸è‡ªåŠ¨åŒ–åŒæ­¥ç³»ç»Ÿ</p>
        </div>

        <div class="main-grid">
            <!-- æ‰‹å†™å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                        âœï¸
                    </div>
                    <div class="card-title">æ‰‹å†™å›¾ç‰‡å¤„ç†</div>
                </div>
                
                <div class="upload-area" id="handwritingUpload">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ æ‰‹å†™å›¾ç‰‡</div>
                    <div class="upload-hint">æ”¯æŒ JPG, PNG, HEIC æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
                </div>
                
                <input type="file" id="handwritingFiles" multiple accept="image/*" style="display: none;">
                
                <div class="file-list" id="handwritingFileList"></div>
                
                <div class="progress-bar hidden" id="handwritingProgress">
                    <div class="progress-fill"></div>
                </div>
                
                <button class="btn" id="processHandwriting" disabled>
                    <span class="loading hidden"></span>
                    ğŸ”„ å¼€å§‹OCRå¤„ç†
                </button>
            </div>

            <!-- GitHubåŒæ­¥åŒºåŸŸ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #2ed573, #1e90ff);">
                        ğŸ”„
                    </div>
                    <div class="card-title">GitHubåŒæ­¥</div>
                </div>
                
                <div class="settings-panel">
                    <div class="form-group">
                        <label class="form-label">ä»“åº“åœ°å€</label>
                        <input type="text" class="form-input" id="repoUrl" placeholder="https://github.com/username/repo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç›®æ ‡åˆ†æ”¯</label>
                        <input type="text" class="form-input" id="targetBranch" value="main">
                    </div>
                </div>
                
                <button class="btn" id="syncToGithub" disabled>
                    <span class="loading hidden"></span>
                    ğŸ“¤ åŒæ­¥åˆ°GitHub
                </button>
                
                <button class="btn btn-secondary" id="listRepoFiles" style="margin-left: 10px;">
                    ğŸ“‹ æŸ¥çœ‹ä»“åº“æ–‡ä»¶
                </button>
            </div>

            <!-- CDNæ›¿æ¢åŒºåŸŸ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #ffa726, #ff7043);">
                        ğŸŒ
                    </div>
                    <div class="card-title">CDN URLæ›¿æ¢</div>
                </div>
                
                <div class="settings-panel">
                    <div class="form-group">
                        <label class="form-label">æœ¬åœ°è·¯å¾„</label>
                        <input type="text" class="form-input" id="localPath" placeholder="/Users/username/Documents/notes">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é™„ä»¶ç›®å½•</label>
                        <input type="text" class="form-input" id="attachmentDir" value="attachments">
                    </div>
                </div>
                
                <button class="btn" id="replaceCdnUrls">
                    <span class="loading hidden"></span>
                    ğŸ”— æ›¿æ¢CDNé“¾æ¥
                </button>
            </div>

            <!-- ä¸€é”®å¤„ç†åŒºåŸŸ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #a855f7, #ec4899);">
                        âš¡
                    </div>
                    <div class="card-title">ä¸€é”®è‡ªåŠ¨åŒ–</div>
                </div>
                
                <p style="margin-bottom: 20px; color: #718096;">è‡ªåŠ¨æ‰§è¡Œå®Œæ•´çš„å¤„ç†æµç¨‹ï¼šOCRè¯†åˆ« â†’ CDNä¸Šä¼  â†’ GitHubåŒæ­¥</p>
                
                <button class="btn" id="oneClickProcess" style="width: 100%; font-size: 1.1rem; padding: 15px;">
                    <span class="loading hidden"></span>
                    ğŸš€ ä¸€é”®å¤„ç†å…¨æµç¨‹
                </button>
            </div>
        </div>

        <!-- çŠ¶æ€é¢æ¿ -->
        <div class="status-panel">
            <h3 style="margin-bottom: 20px; color: #2d3748;">ğŸ“Š å¤„ç†çŠ¶æ€</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-number" id="uploadedCount">0</div>
                    <div class="status-label">å·²ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="status-item">
                    <div class="status-number" id="processedCount">0</div>
                    <div class="status-label">å·²å¤„ç†æ–‡æ¡£</div>
                </div>
                <div class="status-item">
                    <div class="status-number" id="syncedCount">0</div>
                    <div class="status-label">å·²åŒæ­¥æ–‡ä»¶</div>
                </div>
                <div class="status-item">
                    <div class="status-number" id="cdnCount">0</div>
                    <div class="status-label">CDNæ›¿æ¢</div>
                </div>
            </div>
            
            <div class="log-area" id="logArea">
                <div>ğŸ¯ ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æ“ä½œ...</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        const state = {
            uploadedFiles: [],
            processedDocuments: [],
            currentOperation: null,
            stats: {
                uploaded: 0,
                processed: 0,
                synced: 0,
                cdn: 0
            }
        };

        // DOMå…ƒç´ å¼•ç”¨
        const elements = {
            handwritingUpload: document.getElementById('handwritingUpload'),
            handwritingFiles: document.getElementById('handwritingFiles'),
            handwritingFileList: document.getElementById('handwritingFileList'),
            handwritingProgress: document.getElementById('handwritingProgress'),
            processHandwriting: document.getElementById('processHandwriting'),
            syncToGithub: document.getElementById('syncToGithub'),
            listRepoFiles: document.getElementById('listRepoFiles'),
            replaceCdnUrls: document.getElementById('replaceCdnUrls'),
            oneClickProcess: document.getElementById('oneClickProcess'),
            logArea: document.getElementById('logArea'),
            repoUrl: document.getElementById('repoUrl'),
            targetBranch: document.getElementById('targetBranch'),
            localPath: document.getElementById('localPath'),
            attachmentDir: document.getElementById('attachmentDir')
        };

        // æ—¥å¿—ç³»ç»Ÿ
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logEntry.innerHTML = `<span style="color: #718096;">[${timestamp}]</span> ${icon} ${message}`;
            elements.logArea.appendChild(logEntry);
            elements.logArea.scrollTop = elements.logArea.scrollHeight;
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            document.getElementById('uploadedCount').textContent = state.stats.uploaded;
            document.getElementById('processedCount').textContent = state.stats.processed;
            document.getElementById('syncedCount').textContent = state.stats.synced;
            document.getElementById('cdnCount').textContent = state.stats.cdn;
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function setupFileUpload() {
            // æ‹–æ‹½ä¸Šä¼ 
            elements.handwritingUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.handwritingUpload.classList.add('dragover');
            });

            elements.handwritingUpload.addEventListener('dragleave', () => {
                elements.handwritingUpload.classList.remove('dragover');
            });

            elements.handwritingUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.handwritingUpload.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // ç‚¹å‡»ä¸Šä¼ 
            elements.handwritingUpload.addEventListener('click', () => {
                elements.handwritingFiles.click();
            });

            elements.handwritingFiles.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                const isImage = file.type.startsWith('image/');
                const isValidSize = file.size <= 10 * 1024 * 1024; // 10MB
                
                if (!isImage) {
                    addLog(`æ–‡ä»¶ ${file.name} ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼`, 'error');
                    return false;
                }
                
                if (!isValidSize) {
                    addLog(`æ–‡ä»¶ ${file.name} è¶…è¿‡10MBå¤§å°é™åˆ¶`, 'error');
                    return false;
                }
                
                return true;
            });

            if (validFiles.length === 0) return;

            state.uploadedFiles.push(...validFiles);
            state.stats.uploaded += validFiles.length;
            updateStats();
            updateFileList();
            elements.processHandwriting.disabled = false;
            
            addLog(`æˆåŠŸæ·»åŠ  ${validFiles.length} ä¸ªæ–‡ä»¶`, 'success');
        }

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateFileList() {
            elements.handwritingFileList.innerHTML = '';
            
            state.uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                    <button onclick="removeFile(${index})" style="background: none; border: none; color: #e53e3e; cursor: pointer;">ğŸ—‘ï¸</button>
                `;
                elements.handwritingFileList.appendChild(fileItem);
            });
        }

        // ç§»é™¤æ–‡ä»¶
        function removeFile(index) {
            state.uploadedFiles.splice(index, 1);
            state.stats.uploaded--;
            updateStats();
            updateFileList();
            
            if (state.uploadedFiles.length === 0) {
                elements.processHandwriting.disabled = true;
            }
            
            addLog('æ–‡ä»¶å·²ç§»é™¤', 'info');
        }

        // APIè°ƒç”¨è¾…åŠ©å‡½æ•°
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                addLog(`APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // æ‰‹å†™å›¾ç‰‡OCRå¤„ç†
        async function processHandwritingImages() {
            if (state.uploadedFiles.length === 0) return;
            
            const button = elements.processHandwriting;
            const loading = button.querySelector('.loading');
            
            button.disabled = true;
            loading.classList.remove('hidden');
            elements.handwritingProgress.classList.remove('hidden');
            
            addLog('å¼€å§‹æ‰¹é‡OCRå¤„ç†...', 'info');
            
            try {
                for (let i = 0; i < state.uploadedFiles.length; i++) {
                    const file = state.uploadedFiles[i];
                    addLog(`æ­£åœ¨å¤„ç†: ${file.name}`, 'info');
                    
                    // è½¬æ¢ä¸ºbase64
                    const base64 = await fileToBase64(file);
                    
                    // è°ƒç”¨OCR API
                    const result = await apiCall('/api/ocr/recognize', {
                        method: 'POST',
                        body: JSON.stringify({
                            base64Image: base64,
                            options: {
                                language: 'zh-CN',
                                enhance: true
                            }
                        })
                    });
                    
                    if (result.success) {
                        state.processedDocuments.push({
                            filename: file.name,
                            content: result.data.text,
                            originalFile: file
                        });
                        state.stats.processed++;
                        addLog(`${file.name} å¤„ç†å®Œæˆ`, 'success');
                    } else {
                        addLog(`${file.name} å¤„ç†å¤±è´¥: ${result.error}`, 'error');
                    }
                    
                    // æ›´æ–°è¿›åº¦
                    const progress = ((i + 1) / state.uploadedFiles.length) * 100;
                    elements.handwritingProgress.querySelector('.progress-fill').style.width = `${progress}%`;
                }
                
                updateStats();
                elements.syncToGithub.disabled = false;
                addLog('æ‰€æœ‰æ–‡ä»¶OCRå¤„ç†å®Œæˆ', 'success');
                
            } catch (error) {
                addLog(`OCRå¤„ç†å¤±è´¥: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                loading.classList.add('hidden');
                elements.handwritingProgress.classList.add('hidden');
            }
        }

        // æ–‡ä»¶è½¬base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // GitHubåŒæ­¥
        async function syncToGithub() {
            if (state.processedDocuments.length === 0) {
                addLog('æ²¡æœ‰å¯åŒæ­¥çš„æ–‡æ¡£', 'warning');
                return;
            }
            
            const repoUrl = elements.repoUrl.value.trim();
            const branch = elements.targetBranch.value.trim();
            
            if (!repoUrl) {
                addLog('è¯·è¾“å…¥GitHubä»“åº“åœ°å€', 'error');
                return;
            }
            
            const button = elements.syncToGithub;
            const loading = button.querySelector('.loading');
            
            button.disabled = true;
            loading.classList.remove('hidden');
            
            addLog('å¼€å§‹åŒæ­¥åˆ°GitHub...', 'info');
            
            try {
                // è¿™é‡Œè°ƒç”¨GitHubåŒæ­¥API
                const result = await apiCall('/api/github/sync', {
                    method: 'POST',
                    body: JSON.stringify({
                        repoUrl,
                        branch,
                        documents: state.processedDocuments
                    })
                });
                
                if (result.success) {
                    state.stats.synced += state.processedDocuments.length;
                    updateStats();
                    addLog('GitHubåŒæ­¥å®Œæˆ', 'success');
                } else {
                    addLog(`GitHubåŒæ­¥å¤±è´¥: ${result.error}`, 'error');
                }
                
            } catch (error) {
                addLog(`GitHubåŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                loading.classList.add('hidden');
            }
        }

        // CDN URLæ›¿æ¢
        async function replaceCdnUrls() {
            const localPath = elements.localPath.value.trim();
            const attachmentDir = elements.attachmentDir.value.trim();
            
            if (!localPath) {
                addLog('è¯·è¾“å…¥æœ¬åœ°è·¯å¾„', 'error');
                return;
            }
            
            const button = elements.replaceCdnUrls;
            const loading = button.querySelector('.loading');
            
            button.disabled = true;
            loading.classList.remove('hidden');
            
            addLog('å¼€å§‹CDN URLæ›¿æ¢...', 'info');
            
            try {
                const result = await apiCall('/api/cdn/replace', {
                    method: 'POST',
                    body: JSON.stringify({
                        localPath,
                        attachmentDir
                    })
                });
                
                if (result.success) {
                    state.stats.cdn += result.data.replacedCount || 0;
                    updateStats();
                    addLog(`CDNæ›¿æ¢å®Œæˆï¼Œå…±æ›¿æ¢ ${result.data.replacedCount} ä¸ªé“¾æ¥`, 'success');
                } else {
                    addLog(`CDNæ›¿æ¢å¤±è´¥: ${result.error}`, 'error');
                }
                
            } catch (error) {
                addLog(`CDNæ›¿æ¢å¤±è´¥: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                loading.classList.add('hidden');
            }
        }

        // ä¸€é”®å¤„ç†å…¨æµç¨‹
        async function oneClickProcess() {
            if (state.uploadedFiles.length === 0) {
                addLog('è¯·å…ˆä¸Šä¼ æ‰‹å†™å›¾ç‰‡', 'warning');
                return;
            }
            
            const button = elements.oneClickProcess;
            const loading = button.querySelector('.loading');
            
            button.disabled = true;
            loading.classList.remove('hidden');
            
            addLog('ğŸš€ å¼€å§‹ä¸€é”®å¤„ç†å…¨æµç¨‹...', 'info');
            
            try {
                // 1. OCRå¤„ç†
                addLog('æ­¥éª¤ 1/3: OCRè¯†åˆ«å¤„ç†', 'info');
                await processHandwritingImages();
                
                // 2. CDNæ›¿æ¢
                if (elements.localPath.value.trim()) {
                    addLog('æ­¥éª¤ 2/3: CDN URLæ›¿æ¢', 'info');
                    await replaceCdnUrls();
                }
                
                // 3. GitHubåŒæ­¥
                if (elements.repoUrl.value.trim()) {
                    addLog('æ­¥éª¤ 3/3: GitHubåŒæ­¥', 'info');
                    await syncToGithub();
                }
                
                addLog('ğŸ‰ ä¸€é”®å¤„ç†å…¨æµç¨‹å®Œæˆï¼', 'success');
                
            } catch (error) {
                addLog(`ä¸€é”®å¤„ç†å¤±è´¥: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                loading.classList.add('hidden');
            }
        }

        // æŸ¥çœ‹ä»“åº“æ–‡ä»¶
        async function listRepoFiles() {
            const repoUrl = elements.repoUrl.value.trim();
            
            if (!repoUrl) {
                addLog('è¯·è¾“å…¥GitHubä»“åº“åœ°å€', 'error');
                return;
            }
            
            addLog('æ­£åœ¨è·å–ä»“åº“æ–‡ä»¶åˆ—è¡¨...', 'info');
            
            try {
                const result = await apiCall('/api/github/files', {
                    method: 'POST',
                    body: JSON.stringify({ repoUrl })
                });
                
                if (result.success) {
                    addLog(`ä»“åº“æ–‡ä»¶åˆ—è¡¨ (å…±${result.data.files.length}ä¸ªæ–‡ä»¶):`, 'info');
                    result.data.files.forEach(file => {
                        addLog(`ğŸ“„ ${file.path}`, 'info');
                    });
                } else {
                    addLog(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${result.error}`, 'error');
                }
                
            } catch (error) {
                addLog(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
        function setupEventListeners() {
            elements.processHandwriting.addEventListener('click', processHandwritingImages);
            elements.syncToGithub.addEventListener('click', syncToGithub);
            elements.listRepoFiles.addEventListener('click', listRepoFiles);
            elements.replaceCdnUrls.addEventListener('click', replaceCdnUrls);
            elements.oneClickProcess.addEventListener('click', oneClickProcess);
        }

        // åˆå§‹åŒ–
        function init() {
            setupFileUpload();
            setupEventListeners();
            updateStats();
            addLog('æ™ºèƒ½ä¸Šä¼ ä¸­å¿ƒå·²å¯åŠ¨', 'success');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
        
        // å…¨å±€å‡½æ•°æš´éœ²
        window.removeFile = removeFile;
        
        // æ™ºèƒ½ä¸Šä¼ ä¸­å¿ƒJavaScriptåŠŸèƒ½å®ç°
        class UploadCenter {
            constructor() {
                this.apiBase = window.location.origin;
                this.currentFiles = [];
                this.processingResults = [];
                this.init();
            }

            init() {
                this.bindEvents();
                this.updateStatus();
            }

            bindEvents() {
                // æ–‡ä»¶ä¸Šä¼ ç›¸å…³
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.getElementById('uploadArea');
                const processBtn = document.getElementById('processImages');
                const clearBtn = document.getElementById('clearFiles');

                if (fileInput) fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                if (uploadArea) {
                    uploadArea.addEventListener('click', () => fileInput?.click());
                    uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
                    uploadArea.addEventListener('drop', (e) => this.handleDrop(e));
                }
                if (processBtn) processBtn.addEventListener('click', () => this.processImages());
                if (clearBtn) clearBtn.addEventListener('click', () => this.clearFiles());

                // GitHubåŒæ­¥ç›¸å…³
                const syncBtn = document.getElementById('syncToGithub');
                const listBtn = document.getElementById('listRepoFiles');
                if (syncBtn) syncBtn.addEventListener('click', () => this.syncToGithub());
                if (listBtn) listBtn.addEventListener('click', () => this.listRepoFiles());

                // CDNæ›¿æ¢ç›¸å…³
                const cdnBtn = document.getElementById('replaceCdnUrls');
                if (cdnBtn) cdnBtn.addEventListener('click', () => this.replaceCdnUrls());

                // ä¸€é”®è‡ªåŠ¨åŒ–
                const autoBtn = document.getElementById('autoProcess');
                if (autoBtn) autoBtn.addEventListener('click', () => this.autoProcess());
            }

            handleFileSelect(event) {
                const files = Array.from(event.target.files);
                this.addFiles(files);
            }

            handleDragOver(event) {
                event.preventDefault();
                event.currentTarget.classList.add('drag-over');
            }

            handleDrop(event) {
                event.preventDefault();
                event.currentTarget.classList.remove('drag-over');
                const files = Array.from(event.dataTransfer.files);
                this.addFiles(files.filter(file => file.type.startsWith('image/')));
            }

            addFiles(files) {
                files.forEach(file => {
                    if (file.type.startsWith('image/') && file.size <= 10 * 1024 * 1024) {
                        this.currentFiles.push(file);
                    }
                });
                this.updateFileList();
            }

            updateFileList() {
                const fileList = document.getElementById('fileList');
                if (fileList) {
                    fileList.innerHTML = this.currentFiles.map((file, index) => `
                        <div class="file-item">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${(file.size / 1024).toFixed(1)} KB</span>
                            <button onclick="uploadCenter.removeFile(${index})" class="remove-btn">Ã—</button>
                        </div>
                    `).join('');
                }
                
                const processBtn = document.getElementById('processImages');
                if (processBtn) processBtn.disabled = this.currentFiles.length === 0;
            }

            removeFile(index) {
                this.currentFiles.splice(index, 1);
                this.updateFileList();
            }

            clearFiles() {
                this.currentFiles = [];
                this.processingResults = [];
                this.updateFileList();
                this.updateResults();
            }

            async processImages() {
                if (this.currentFiles.length === 0) return;

                this.showLoading('æ­£åœ¨å¤„ç†å›¾ç‰‡...');
                
                try {
                    const formData = new FormData();
                    this.currentFiles.forEach((file, index) => {
                        formData.append(`images`, file);
                    });
                    formData.append('options', JSON.stringify({
                        language: 'zh-cn',
                        enhance: true,
                        generateMarkdown: true
                    }));

                    const response = await fetch(`${this.apiBase}/api/batch-ocr/process`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        this.processingResults = result.data.results;
                        this.updateResults();
                        this.showSuccess('å›¾ç‰‡å¤„ç†å®Œæˆï¼');
                    } else {
                        throw new Error(result.error || 'å¤„ç†å¤±è´¥');
                    }
                } catch (error) {
                    console.error('Processing error:', error);
                    this.showError(`å¤„ç†å¤±è´¥: ${error.message}`);
                } finally {
                    this.hideLoading();
                }
            }

            async syncToGithub() {
                if (this.processingResults.length === 0) {
                    this.showError('è¯·å…ˆå¤„ç†å›¾ç‰‡');
                    return;
                }

                this.showLoading('æ­£åœ¨åŒæ­¥åˆ°GitHub...');

                try {
                    const documents = this.processingResults.map((result, index) => {
                        // ç”Ÿæˆç²¾ç¡®åˆ°åˆ†é’Ÿçš„æ–‡ä»¶åï¼Œé¿å…è¦†ç›–
                        const now = new Date();
                        const dateStr = now.toISOString().slice(0, 16).replace('T', '_').replace(/:/g, '-'); // YYYY-MM-DD_HH-MM
                        return {
                            filename: `handwritten_${dateStr}_${index + 1}.md`,
                            content: result.markdownContent,
                            metadata: {
                                originalImage: result.imageUrl,
                                confidence: result.confidence,
                                processedAt: new Date().toISOString()
                            }
                        };
                    });

                    const response = await fetch(`${this.apiBase}/api/github-sync/sync`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            documents,
                            repoInfo: {
                                owner: 'your-username',
                                repo: 'your-repo',
                                branch: 'main'
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        this.showSuccess(`æˆåŠŸåŒæ­¥ ${result.data.summary.syncedCount} ä¸ªæ–‡ä»¶åˆ°GitHub`);
                    } else {
                        throw new Error(result.error || 'åŒæ­¥å¤±è´¥');
                    }
                } catch (error) {
                    console.error('GitHub sync error:', error);
                    this.showError(`GitHubåŒæ­¥å¤±è´¥: ${error.message}`);
                } finally {
                    this.hideLoading();
                }
            }

            async listRepoFiles() {
                this.showLoading('æ­£åœ¨è·å–ä»“åº“æ–‡ä»¶åˆ—è¡¨...');

                try {
                    const response = await fetch(`${this.apiBase}/api/github-sync/list`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            repoInfo: {
                                owner: 'your-username',
                                repo: 'your-repo',
                                branch: 'main'
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        this.displayRepoFiles(result.data.files);
                    } else {
                        throw new Error(result.error || 'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                    }
                } catch (error) {
                    console.error('List files error:', error);
                    this.showError(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`);
                } finally {
                    this.hideLoading();
                }
            }

            async replaceCdnUrls() {
                if (this.processingResults.length === 0) {
                    this.showError('è¯·å…ˆå¤„ç†å›¾ç‰‡');
                    return;
                }

                this.showLoading('æ­£åœ¨æ›¿æ¢CDN URL...');

                try {
                    const documents = this.processingResults.map(result => ({
                        content: result.markdownContent,
                        filename: result.filename || 'untitled.md'
                    }));

                    const response = await fetch(`${this.apiBase}/api/cdn-replacement/batch-replace`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            documents,
                            baseUrl: 'https://imagedelivery.net/your-account-id'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        result.data.documents.forEach((doc, index) => {
                            if (this.processingResults[index]) {
                                this.processingResults[index].markdownContent = doc.content;
                            }
                        });
                        this.updateResults();
                        this.showSuccess(`æˆåŠŸæ›¿æ¢ ${result.data.summary.totalReplacements} ä¸ªURL`);
                    } else {
                        throw new Error(result.error || 'CDN URLæ›¿æ¢å¤±è´¥');
                    }
                } catch (error) {
                    console.error('CDN replacement error:', error);
                    this.showError(`CDN URLæ›¿æ¢å¤±è´¥: ${error.message}`);
                } finally {
                    this.hideLoading();
                }
            }

            async autoProcess() {
                if (this.currentFiles.length === 0) {
                    this.showError('è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }

                try {
                    await this.processImages();
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    await this.replaceCdnUrls();
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    await this.syncToGithub();

                    this.showSuccess('ä¸€é”®è‡ªåŠ¨åŒ–å¤„ç†å®Œæˆï¼');
                } catch (error) {
                    console.error('Auto process error:', error);
                    this.showError(`è‡ªåŠ¨åŒ–å¤„ç†å¤±è´¥: ${error.message}`);
                }
            }

            updateResults() {
                const resultsArea = document.getElementById('resultsArea');
                if (!resultsArea) return;
                
                if (this.processingResults.length === 0) {
                    resultsArea.innerHTML = '<p class="no-results">æš‚æ— å¤„ç†ç»“æœ</p>';
                    return;
                }

                resultsArea.innerHTML = this.processingResults.map((result, index) => `
                    <div class="result-item">
                        <div class="result-header">
                            <h4>å›¾ç‰‡ ${index + 1}</h4>
                            <span class="confidence">ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}%</span>
                        </div>
                        <div class="result-content">
                            <div class="ocr-text">
                                <h5>è¯†åˆ«æ–‡æœ¬:</h5>
                                <p>${result.text || 'æœªè¯†åˆ«åˆ°æ–‡å­—'}</p>
                            </div>
                            <div class="markdown-content">
                                <h5>Markdownå†…å®¹:</h5>
                                <pre><code>${result.markdownContent || 'æ— å†…å®¹'}</code></pre>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            displayRepoFiles(files) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>ä»“åº“æ–‡ä»¶åˆ—è¡¨</h3>
                            <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="file-tree">
                                ${files.map(file => `
                                    <div class="file-tree-item">
                                        <span class="file-icon">${file.type === 'dir' ? 'ğŸ“' : 'ğŸ“„'}</span>
                                        <span class="file-name">${file.name}</span>
                                        <span class="file-size">${file.size ? (file.size / 1024).toFixed(1) + ' KB' : ''}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            updateStatus() {
                const statusElement = document.getElementById('systemStatus');
                if (statusElement) {
                    statusElement.textContent = 'ç³»ç»Ÿè¿è¡Œæ­£å¸¸';
                    statusElement.className = 'status-text status-success';
                }
            }

            showLoading(message) {
                const loading = document.getElementById('loadingIndicator');
                if (loading) {
                    loading.textContent = message;
                    loading.style.display = 'block';
                }
            }

            hideLoading() {
                const loading = document.getElementById('loadingIndicator');
                if (loading) loading.style.display = 'none';
            }

            showSuccess(message) {
                this.showMessage(message, 'success');
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showMessage(message, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${type}`;
                messageDiv.textContent = message;
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    background: ${type === 'success' ? '#48bb78' : '#f56565'};
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 5000);
            }
        }

        // åˆå§‹åŒ–ä¸Šä¼ ä¸­å¿ƒ
        const uploadCenter = new UploadCenter();
        console.log('æ™ºèƒ½ä¸Šä¼ ä¸­å¿ƒå·²åŠ è½½');
    </script>
</body>
</html>