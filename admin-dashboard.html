<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能笔记处理系统 - 管理控制台</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
            --info-color: #4299e1;
            --bg-primary: #f7fafc;
            --bg-secondary: #edf2f7;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* 侧边栏样式 */
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: var(--shadow-lg);
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .sidebar-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .sidebar-nav {
            padding: 2rem 0;
        }

        .nav-item {
            display: block;
            padding: 1rem 2rem;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: white;
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
        }

        /* 主内容区域 */
        .main-content {
            padding: 2rem;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .page-description {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* 卡片样式 */
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: var(--primary-color);
        }

        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        /* 网格布局 */
        .grid {
            display: grid;
            gap: 2rem;
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        /* 状态指示器 */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-success {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success-color);
        }

        .status-warning {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning-color);
        }

        .status-error {
            background: rgba(245, 101, 101, 0.1);
            color: var(--error-color);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* 上传区域 */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--bg-primary);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* 进度条 */
        .progress {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }

        /* 移动端菜单按钮 */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        /* 移动端遮罩 */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-overlay.active {
            opacity: 1;
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .mobile-overlay {
                display: block;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
                box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                padding: 80px 1rem 1rem;
            }

            .page-header {
                margin-bottom: 1.5rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .card {
                padding: 1rem;
            }

            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 70px 0.5rem 0.5rem;
            }

            .card {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }

            .page-title {
                font-size: 1.25rem;
            }

            .btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
            }

            .form-input,
            .form-select,
            .form-textarea {
                padding: 0.6rem;
                font-size: 0.9rem;
            }

            .upload-area {
                padding: 2rem 1rem;
            }

            .upload-icon {
                font-size: 2rem;
            }
        }

        /* Gallery样式 */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-secondary);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .gallery-item-info {
            padding: 0.75rem;
        }

        .gallery-item-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gallery-item-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .gallery-loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .gallery-loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .gallery-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-top: 1px solid var(--border-color);
        }

        .card-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .card-actions .form-select,
        .card-actions .form-input {
            width: auto;
            min-width: 150px;
        }

        /* 图片预览模态框 */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .image-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .image-modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .image-modal-info {
            position: absolute;
            bottom: -60px;
            left: 0;
            right: 0;
            color: white;
            text-align: center;
            padding: 1rem;
        }

        /* 隐藏类 */
        .hidden {
            display: none;
        }

        /* 动画 */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- 移动端菜单按钮 -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- 移动端遮罩 -->
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>
    
    <div class="dashboard">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">智能笔记系统</h1>
                <p class="sidebar-subtitle">管理控制台</p>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-page="overview">
                    <i class="fas fa-tachometer-alt"></i>
                    系统概览
                </a>
                <a href="#" class="nav-item" data-page="sync-control">
                    <i class="fas fa-sync-alt"></i>
                    笔记同步控制
                </a>
                <a href="#" class="nav-item" data-page="link-replacement">
                    <i class="fas fa-link"></i>
                    链接替换管理
                </a>
                <a href="#" class="nav-item" data-page="handwriting-upload">
                    <i class="fas fa-pen-fancy"></i>
                    手写笔记处理
                </a>
                <a href="#" class="nav-item" data-page="batch-processing">
                    <i class="fas fa-layer-group"></i>
                    批量处理
                </a>
                <a href="#" class="nav-item" data-page="github-sync">
                    <i class="fab fa-github"></i>
                    GitHub同步
                </a>
                <a href="#" class="nav-item" data-page="gallery">
                    <i class="fas fa-images"></i>
                    图床Gallery
                </a>
                <a href="#" class="nav-item" data-page="automation">
                    <i class="fas fa-robot"></i>
                    自动化管理
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    系统设置
                </a>
            </nav>
        </aside>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 系统概览页面 -->
            <div id="overview-page" class="page">
                <div class="page-header">
                    <h1 class="page-title">系统概览</h1>
                    <p class="page-description">查看系统运行状态和关键指标</p>
                </div>

                <!-- 状态卡片 -->
                <div class="grid grid-3">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-server"></i>
                                系统状态
                            </div>
                            <div class="status-indicator status-success">
                                <div class="status-dot"></div>
                                运行正常
                            </div>
                        </div>
                        <div class="card-content">
                            <p>服务器运行时间: <strong>24小时</strong></p>
                            <p>API响应时间: <strong>120ms</strong></p>
                            <p>内存使用率: <strong>45%</strong></p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-images"></i>
                                图片处理
                            </div>
                            <div class="status-indicator status-success">
                                <div class="status-dot"></div>
                                正常
                            </div>
                        </div>
                        <div class="card-content">
                            <p>今日处理: <strong>156张</strong></p>
                            <p>成功率: <strong>98.5%</strong></p>
                            <p>平均处理时间: <strong>3.2秒</strong></p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fab fa-github"></i>
                                GitHub同步
                            </div>
                            <div id="github-status-indicator" class="status-indicator status-success">
                                <div class="status-dot"></div>
                                <span id="github-status-text">已同步</span>
                            </div>
                        </div>
                        <div class="card-content">
                            <p>最后同步: <strong id="github-last-sync">加载中...</strong></p>
                            <p>同步文件: <strong id="github-sync-files">加载中...</strong></p>
                            <p>仓库状态: <strong id="github-repo-status">加载中...</strong></p>
                            <p>当前分支: <strong id="github-current-branch">加载中...</strong></p>
                            <p>最新提交: <strong id="github-latest-commit">加载中...</strong></p>
                            <button class="btn btn-primary btn-sm" onclick="refreshGitHubStatus()" style="margin-top: 10px;">
                                <i class="fas fa-refresh"></i>
                                刷新状态
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 快速操作 -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-bolt"></i>
                            快速操作
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="grid grid-2">
                            <button class="btn btn-primary" onclick="refreshSystemStatus()">
                                <i class="fas fa-sync-alt"></i>
                                刷新系统状态
                            </button>
                            <button class="btn btn-secondary" onclick="showPage('handwriting-upload')">
                                <i class="fas fa-upload"></i>
                                上传手写笔记
                            </button>
                            <button class="btn btn-success" onclick="triggerSync()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                立即同步
                            </button>
                            <button class="btn btn-warning" onclick="showPage('batch-processing')">
                                <i class="fas fa-layer-group"></i>
                                批量处理
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 笔记同步控制页面 -->
            <div id="sync-control-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">笔记同步控制</h1>
                    <p class="page-description">管理Obsidian笔记库与云端的同步</p>
                </div>

                <div class="grid grid-2">
                    <!-- 同步状态 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-sync-alt"></i>
                                同步状态
                            </div>
                            <button class="btn btn-primary" onclick="checkSyncStatus()">
                                <i class="fas fa-refresh"></i>
                                检查状态
                            </button>
                        </div>
                        <div class="card-content">
                            <div id="sync-status-content">
                                <div class="status-indicator status-success">
                                    <div class="status-dot"></div>
                                    同步正常
                                </div>
                                <p>最后同步时间: <span id="last-sync-time">2024-01-15 14:30:25</span></p>
                                <p>同步文件数: <span id="sync-file-count">156</span></p>
                                <p>待同步文件: <span id="pending-sync-count">3</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- 同步控制 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-cogs"></i>
                                同步控制
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label class="form-label">同步模式</label>
                                <select class="form-select" id="sync-mode">
                                    <option value="auto">自动同步</option>
                                    <option value="manual">手动同步</option>
                                    <option value="scheduled">定时同步</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">同步间隔（分钟）</label>
                                <input type="number" class="form-input" id="sync-interval" value="30" min="1" max="1440">
                            </div>
                            <button class="btn btn-success" onclick="startSync()">
                                <i class="fas fa-play"></i>
                                开始同步
                            </button>
                            <button class="btn btn-warning" onclick="pauseSync()">
                                <i class="fas fa-pause"></i>
                                暂停同步
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 同步日志 -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-list-alt"></i>
                            同步日志
                        </div>
                        <button class="btn btn-secondary" onclick="clearSyncLog()">
                            <i class="fas fa-trash"></i>
                            清空日志
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="sync-log" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; line-height: 1.4;">
                            <div>[2024-01-15 14:30:25] 开始同步操作...</div>
                            <div>[2024-01-15 14:30:26] 检测到3个新文件</div>
                            <div>[2024-01-15 14:30:27] 上传文件: note-001.md</div>
                            <div>[2024-01-15 14:30:28] 上传文件: image-001.png</div>
                            <div>[2024-01-15 14:30:29] 同步完成，共处理3个文件</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 链接替换管理页面 -->
            <div id="link-replacement-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">链接替换管理</h1>
                    <p class="page-description">管理CDN链接替换和图片链接优化</p>
                </div>

                <div class="grid grid-2">
                    <!-- 替换规则 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-exchange-alt"></i>
                                替换规则
                            </div>
                            <button class="btn btn-primary" onclick="addReplacementRule()">
                                <i class="fas fa-plus"></i>
                                添加规则
                            </button>
                        </div>
                        <div class="card-content">
                            <div id="replacement-rules">
                                <div class="rule-item" style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>本地图片 → CDN</strong>
                                            <p style="color: var(--text-secondary); font-size: 0.9rem;">attachments/* → https://cdn.example.com/*</p>
                                        </div>
                                        <div>
                                            <button class="btn btn-secondary" style="padding: 0.5rem;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger" style="padding: 0.5rem; margin-left: 0.5rem;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 批量替换 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-magic"></i>
                                批量替换
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label class="form-label">本地笔记路径</label>
                                <input type="text" class="form-input" id="notes-path" value="/Users/lipeiyang/Documents/notes" placeholder="笔记文件夹路径">
                            </div>
                            <div class="form-group">
                                <label class="form-label">源路径模式</label>
                                <input type="text" class="form-input" id="source-pattern" value="attachments/*.png" placeholder="例: attachments/*.png">
                            </div>
                            <div class="form-group">
                                <label class="form-label">目标URL模式</label>
                                <input type="text" class="form-input" id="target-pattern" value="https://cdn.example.com/{filename}" placeholder="例: https://cdn.example.com/{filename}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">处理范围</label>
                                <select class="form-select" id="replacement-scope">
                                    <option value="all">所有文件</option>
                                    <option value="modified">最近修改的文件</option>
                                    <option value="specific">指定文件夹</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">快捷键提示</label>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">按 <kbd>Ctrl+Shift+R</kbd> (Mac: <kbd>Cmd+Shift+R</kbd>) 快速执行批量替换</p>
                            </div>
                            <button class="btn btn-success" onclick="startBatchReplacement()">
                                <i class="fas fa-play"></i>
                                开始替换
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 替换历史 -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-history"></i>
                            替换历史
                        </div>
                    </div>
                    <div class="card-content">
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <th style="padding: 1rem; text-align: left;">时间</th>
                                        <th style="padding: 1rem; text-align: left;">文件</th>
                                        <th style="padding: 1rem; text-align: left;">替换数量</th>
                                        <th style="padding: 1rem; text-align: left;">状态</th>
                                    </tr>
                                </thead>
                                <tbody id="replacement-history">
                                    <!-- 动态加载替换历史记录 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 手写笔记处理页面 -->
            <div id="handwriting-upload-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">手写笔记处理</h1>
                    <p class="page-description">上传手写笔记图片，自动进行OCR识别和Markdown转换</p>
                </div>

                <div class="grid grid-2">
                    <!-- 上传区域 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-cloud-upload-alt"></i>
                                图片上传
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="upload-area" id="handwriting-upload-area">
                                <div class="upload-icon">
                                    <i class="fas fa-images"></i>
                                </div>
                                <div class="upload-text">拖拽图片到此处或点击上传</div>
                                <div class="upload-hint">支持 JPG、PNG、WebP 格式，最大 10MB</div>
                                <input type="file" id="handwriting-file-input" multiple accept="image/*" style="display: none;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">OCR提供商</label>
                                <select class="form-select" id="ocr-provider">
                                    <option value="baidu">百度OCR</option>
                                    <option value="tencent">腾讯OCR</option>
                                    <option value="aliyun">阿里云OCR</option>
                                    <option value="glm4v">GLM-4V</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">处理选项</label>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="enable-formula-recognition" checked>
                                        启用公式识别
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="enable-smart-formatting" checked>
                                        智能格式化
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="enable-auto-backup" checked>
                                        自动备份原图
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 处理状态 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-tasks"></i>
                                处理状态
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="processing-status" class="hidden">
                                <div class="progress" style="margin-bottom: 1rem;">
                                    <div class="progress-bar" id="processing-progress" style="width: 0%;"></div>
                                </div>
                                <div id="processing-info">
                                    <p>正在处理: <span id="current-file">-</span></p>
                                    <p>进度: <span id="progress-text">0/0</span></p>
                                    <p>预计剩余时间: <span id="estimated-time">-</span></p>
                                </div>
                            </div>
                            <div id="processing-results" class="hidden">
                                <h4 style="margin-bottom: 1rem;">处理结果</h4>
                                <div id="results-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 历史记录 -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-history"></i>
                            处理历史
                        </div>
                        <button class="btn btn-secondary" onclick="clearProcessingHistory()">
                            <i class="fas fa-trash"></i>
                            清空历史
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="processing-history">
                            <!-- 历史记录将在这里动态生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 批量处理页面 -->
            <div id="batch-processing-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">批量处理</h1>
                    <p class="page-description">批量处理多个文件和图片</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-layer-group"></i>
                            批量OCR处理
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label">处理类型</label>
                                <select class="form-select" id="batch-type">
                                    <option value="handwriting">手写笔记</option>
                                    <option value="document">文档扫描</option>
                                    <option value="formula">数学公式</option>
                                    <option value="mixed">混合内容</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">并发数量</label>
                                <input type="number" class="form-input" id="batch-concurrency" value="3" min="1" max="10">
                            </div>
                        </div>
                        <div class="upload-area" id="batch-upload-area">
                            <div class="upload-icon">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <div class="upload-text">选择多个图片文件进行批量处理</div>
                            <div class="upload-hint">支持同时上传多个文件</div>
                            <input type="file" id="batch-file-input" multiple accept="image/*" style="display: none;">
                        </div>
                        <button class="btn btn-primary" onclick="startBatchProcessing()">
                            <i class="fas fa-play"></i>
                            开始批量处理
                        </button>
                    </div>
                </div>
            </div>

            <!-- GitHub同步页面 -->
            <div id="github-sync-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">GitHub同步</h1>
                    <p class="page-description">管理与GitHub仓库的同步</p>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fab fa-github"></i>
                                仓库配置
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label class="form-label">仓库地址</label>
                                <input type="text" class="form-input" id="github-repo" placeholder="username/repository">
                            </div>
                            <div class="form-group">
                                <label class="form-label">分支</label>
                                <input type="text" class="form-input" id="github-branch" value="main">
                            </div>
                            <div class="form-group">
                                <label class="form-label">访问令牌</label>
                                <input type="password" class="form-input" id="github-token" placeholder="ghp_...">
                            </div>
                            <button class="btn btn-success" onclick="testGitHubConnection()">
                                <i class="fas fa-plug"></i>
                                测试连接
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-sync-alt"></i>
                                同步操作
                            </div>
                        </div>
                        <div class="card-content">
                            <button class="btn btn-primary" onclick="syncToGitHub()">
                                <i class="fas fa-upload"></i>
                                推送到GitHub
                            </button>
                            <button class="btn btn-secondary" onclick="pullFromGitHub()">
                                <i class="fas fa-download"></i>
                                从GitHub拉取
                            </button>
                            <button class="btn btn-warning" onclick="forceSync()">
                                <i class="fas fa-exclamation-triangle"></i>
                                强制同步
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 自动化管理页面 -->
            <div id="automation-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">自动化管理</h1>
                    <p class="page-description">配置和管理自动化任务</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-robot"></i>
                            自动化任务
                        </div>
                        <button class="btn btn-primary" onclick="createAutomationTask()">
                            <i class="fas fa-plus"></i>
                            创建任务
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="automation-tasks">
                            <!-- 自动化任务列表 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 图床Gallery页面 -->
            <div id="gallery-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">图床Gallery</h1>
                    <p class="page-description">管理和浏览已上传的图片资源</p>
                </div>

                <div class="grid grid-2">
                    <!-- 图片统计 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                图片统计
                            </div>
                            <button class="btn btn-primary" onclick="refreshGalleryStats()">
                                <i class="fas fa-refresh"></i>
                                刷新统计
                            </button>
                        </div>
                        <div class="card-content">
                            <p>总图片数: <strong id="total-images">加载中...</strong></p>
                            <p>总大小: <strong id="total-size">加载中...</strong></p>
                            <p>今日上传: <strong id="today-uploads">加载中...</strong></p>
                            <p>存储使用率: <strong id="storage-usage">加载中...</strong></p>
                        </div>
                    </div>

                    <!-- 快速操作 -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-tools"></i>
                                快速操作
                            </div>
                        </div>
                        <div class="card-content">
                            <button class="btn btn-primary" onclick="showPage('handwriting-upload')">
                                <i class="fas fa-upload"></i>
                                上传新图片
                            </button>
                            <button class="btn btn-secondary" onclick="cleanupGallery()">
                                <i class="fas fa-broom"></i>
                                清理无效图片
                            </button>
                            <button class="btn btn-warning" onclick="exportGalleryList()">
                                <i class="fas fa-download"></i>
                                导出图片列表
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 图片浏览器 -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-images"></i>
                            图片浏览器
                        </div>
                        <div class="card-actions">
                            <select class="form-select" id="gallery-filter" onchange="filterGallery()">
                                <option value="all">全部图片</option>
                                <option value="today">今日上传</option>
                                <option value="week">本周上传</option>
                                <option value="month">本月上传</option>
                            </select>
                            <input type="text" class="form-input" id="gallery-search" placeholder="搜索图片..." oninput="searchGallery()">
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="gallery-grid" class="gallery-grid">
                            <!-- 图片网格将在这里动态加载 -->
                            <div class="gallery-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>正在加载图片...</p>
                            </div>
                        </div>
                        <div class="gallery-pagination">
                            <button class="btn btn-secondary" id="prev-page" onclick="loadGalleryPage('prev')" disabled>
                                <i class="fas fa-chevron-left"></i>
                                上一页
                            </button>
                            <span id="page-info">第 1 页，共 1 页</span>
                            <button class="btn btn-secondary" id="next-page" onclick="loadGalleryPage('next')" disabled>
                                下一页
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系统设置页面 -->
            <div id="settings-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">系统设置</h1>
                    <p class="page-description">配置系统参数和API密钥</p>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-key"></i>
                                API配置
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label class="form-label">Cloudflare API Token</label>
                                <input type="password" class="form-input" id="cloudflare-token">
                            </div>
                            <div class="form-group">
                                <label class="form-label">GLM API Key</label>
                                <input type="password" class="form-input" id="glm-api-key">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Telegram Bot Token</label>
                                <input type="password" class="form-input" id="telegram-token">
                            </div>
                            <button class="btn btn-success" onclick="saveAPISettings()">
                                <i class="fas fa-save"></i>
                                保存设置
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-cogs"></i>
                                系统参数
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label class="form-label">默认图片质量</label>
                                <input type="range" class="form-input" id="image-quality" min="0.1" max="1" step="0.1" value="0.8">
                                <span id="quality-value">80%</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">最大并发处理数</label>
                                <input type="number" class="form-input" id="max-concurrency" value="5" min="1" max="20">
                            </div>
                            <div class="form-group">
                                <label class="form-label">自动备份</label>
                                <select class="form-select" id="auto-backup">
                                    <option value="enabled">启用</option>
                                    <option value="disabled">禁用</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 全局变量
        let currentPage = 'overview';
        let apiBase = window.location.origin;

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            bindEvents();
            loadSystemStatus();
        });

        /**
         * 初始化应用
         */
        function initializeApp() {
            console.log('智能笔记处理系统管理控制台已启动');
            
            // 设置API基础URL
            if (window.location.hostname === 'localhost') {
                apiBase = 'http://localhost:8787';
            }
            
            // 加载保存的设置
            loadSavedSettings();
        }

        /**
         * 绑定事件监听器
         */
        function bindEvents() {
            // 导航菜单点击事件
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    showPage(page);
                });
            });

            // 文件上传事件
            setupFileUpload();
            
            // 图片质量滑块事件
            const qualitySlider = document.getElementById('image-quality');
            if (qualitySlider) {
                qualitySlider.addEventListener('input', function() {
                    document.getElementById('quality-value').textContent = Math.round(this.value * 100) + '%';
                });
            }
        }

        /**
         * 显示指定页面
         */
        function showPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.classList.add('fade-in');
            }
            
            // 更新导航状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNav = document.querySelector(`[data-page="${pageId}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }
            
            currentPage = pageId;
            
            // 页面特定的初始化
            switch(pageId) {
                case 'overview':
                    loadSystemStatus();
                    break;
                case 'sync-control':
                    loadSyncStatus();
                    break;
                case 'link-replacement':
                    loadReplacementRules();
                    break;
                case 'handwriting-upload':
                    initializeHandwritingUpload();
                    break;
                case 'gallery':
                    loadGallery();
                    break;
            }
        }

        /**
         * 设置文件上传功能
         */
        function setupFileUpload() {
            // 手写笔记上传
            const handwritingUploadArea = document.getElementById('handwriting-upload-area');
            const handwritingFileInput = document.getElementById('handwriting-file-input');
            
            if (handwritingUploadArea && handwritingFileInput) {
                handwritingUploadArea.addEventListener('click', () => {
                    handwritingFileInput.click();
                });
                
                handwritingUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    handwritingUploadArea.classList.add('dragover');
                });
                
                handwritingUploadArea.addEventListener('dragleave', () => {
                    handwritingUploadArea.classList.remove('dragover');
                });
                
                handwritingUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    handwritingUploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    handleHandwritingFiles(files);
                });
                
                handwritingFileInput.addEventListener('change', (e) => {
                    handleHandwritingFiles(e.target.files);
                });
            }
            
            // 批量处理上传
            const batchUploadArea = document.getElementById('batch-upload-area');
            const batchFileInput = document.getElementById('batch-file-input');
            
            if (batchUploadArea && batchFileInput) {
                batchUploadArea.addEventListener('click', () => {
                    batchFileInput.click();
                });
                
                batchFileInput.addEventListener('change', (e) => {
                    handleBatchFiles(e.target.files);
                });
            }
        }

        /**
         * 处理手写笔记文件上传
         */
        async function handleHandwritingFiles(files) {
            if (files.length === 0) return;
            
            const processingStatus = document.getElementById('processing-status');
            const processingResults = document.getElementById('processing-results');
            
            processingStatus.classList.remove('hidden');
            processingResults.classList.add('hidden');
            
            const results = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // 更新进度
                updateProcessingProgress(i + 1, files.length, file.name);
                
                try {
                    const result = await processHandwritingFile(file);
                    results.push(result);
                } catch (error) {
                    console.error('处理文件失败:', error);
                    results.push({ error: error.message, filename: file.name });
                }
            }
            
            // 显示结果
            showProcessingResults(results);
            processingStatus.classList.add('hidden');
        }

        /**
         * 处理单个手写笔记文件
         */
        async function processHandwritingFile(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            const options = {
                provider: document.getElementById('ocr-provider').value,
                enableFormula: document.getElementById('enable-formula-recognition').checked,
                smartFormatting: document.getElementById('enable-smart-formatting').checked,
                autoBackup: document.getElementById('enable-auto-backup').checked
            };
            
            formData.append('options', JSON.stringify(options));
            
            const response = await fetch(`${apiBase}/api/process/handwritten`, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }

        /**
         * 更新处理进度
         */
        function updateProcessingProgress(current, total, filename) {
            const progress = (current / total) * 100;
            document.getElementById('processing-progress').style.width = progress + '%';
            document.getElementById('current-file').textContent = filename;
            document.getElementById('progress-text').textContent = `${current}/${total}`;
            
            // 估算剩余时间（简单估算）
            const avgTimePerFile = 3; // 假设每个文件平均3秒
            const remainingTime = (total - current) * avgTimePerFile;
            document.getElementById('estimated-time').textContent = remainingTime > 0 ? `${remainingTime}秒` : '完成';
        }

        /**
         * 显示处理结果
         */
        function showProcessingResults(results) {
            const resultsContainer = document.getElementById('results-list');
            const processingResults = document.getElementById('processing-results');
            
            resultsContainer.innerHTML = '';
            
            results.forEach((result, index) => {
                const resultItem = document.createElement('div');
                resultItem.style.cssText = 'padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem;';
                
                if (result.error) {
                    resultItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--error-color);">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>${result.filename}</strong> - 处理失败
                        </div>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem;">${result.error}</p>
                    `;
                } else {
                    resultItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--success-color);">
                            <i class="fas fa-check-circle"></i>
                            <strong>${result.filename || `文件${index + 1}`}</strong> - 处理成功
                        </div>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem;">识别文字: ${result.text ? result.text.substring(0, 100) + '...' : '无'}</p>
                        ${result.markdownUrl ? `<a href="${result.markdownUrl}" target="_blank" class="btn btn-secondary" style="margin-top: 0.5rem;">查看Markdown</a>` : ''}
                    `;
                }
                
                resultsContainer.appendChild(resultItem);
            });
            
            processingResults.classList.remove('hidden');
        }

        /**
         * 加载系统状态
         */
        async function loadSystemStatus() {
            try {
                const response = await fetch(`${apiBase}/api/stats`);
                if (response.ok) {
                    const stats = await response.json();
                    updateSystemStatusDisplay(stats);
                }
            } catch (error) {
                console.error('加载系统状态失败:', error);
            }
        }

        /**
         * 更新系统状态显示
         */
        function updateSystemStatusDisplay(stats) {
            // 这里可以根据实际的stats数据更新显示
            console.log('系统状态:', stats);
        }

        /**
         * 加载同步状态
         */
        async function loadSyncStatus() {
            try {
                const response = await fetch(`${apiBase}/api/sync/status`);
                if (response.ok) {
                    const status = await response.json();
                    updateSyncStatusDisplay(status);
                }
            } catch (error) {
                console.error('加载同步状态失败:', error);
            }
        }

        /**
         * 更新同步状态显示
         */
        function updateSyncStatusDisplay(status) {
            console.log('同步状态:', status);
            
            // 更新最后同步时间
            const lastSyncElement = document.getElementById('last-sync-time');
            if (lastSyncElement && status.lastSync) {
                const syncTime = new Date(status.lastSync);
                lastSyncElement.textContent = syncTime.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            // 更新同步文件数
            const syncFileCountElement = document.getElementById('sync-file-count');
            if (syncFileCountElement && status.filesProcessed !== undefined) {
                syncFileCountElement.textContent = status.filesProcessed;
            }
            
            // 更新待同步文件数（这里假设为0，因为API没有提供这个字段）
            const pendingSyncCountElement = document.getElementById('pending-sync-count');
            if (pendingSyncCountElement) {
                pendingSyncCountElement.textContent = status.errors || 0;
            }
        }

        /**
         * 加载替换规则
         */
        function loadReplacementRules() {
            // 加载CDN替换规则
            console.log('加载替换规则');
        }

        /**
         * 初始化手写笔记上传
         */
        function initializeHandwritingUpload() {
            // 初始化手写笔记上传功能
            console.log('初始化手写笔记上传');
        }

        /**
         * 加载保存的设置
         */
        function loadSavedSettings() {
            // 从localStorage加载保存的设置
            const savedSettings = localStorage.getItem('noteSystemSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                // 应用设置到界面
                console.log('加载保存的设置:', settings);
            }
        }

        /**
         * 切换移动端菜单
         */
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            
            // 切换菜单按钮图标
            const icon = menuBtn.querySelector('i');
            if (sidebar.classList.contains('mobile-open')) {
                icon.className = 'fas fa-times';
            } else {
                icon.className = 'fas fa-bars';
            }
        }

        /**
         * 关闭移动端菜单
         */
        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            
            // 重置菜单按钮图标
            const icon = menuBtn.querySelector('i');
            icon.className = 'fas fa-bars';
        }

        /**
         * 处理窗口大小变化
         */
        function handleResize() {
            if (window.innerWidth > 768) {
                // 桌面端时关闭移动端菜单
                closeMobileMenu();
            }
        }

        // 监听窗口大小变化
        window.addEventListener('resize', handleResize);

        /**
         * 检测后台服务状态
         */
        async function checkBackendService() {
            try {
                const response = await fetch(`${apiBase}/api/stats`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        /**
         * 显示后台服务状态
         */
        function showBackendStatus(isRunning) {
            let statusElement = document.getElementById('backend-status');
            if (!statusElement) {
                // 创建状态显示元素
                statusElement = document.createElement('div');
                statusElement.id = 'backend-status';
                statusElement.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 20px;
                    padding: 8px 12px;
                    border-radius: 6px;
                    color: white;
                    font-size: 14px;
                    font-weight: 500;
                    z-index: 1000;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                `;
                document.body.appendChild(statusElement);
            }
            
            if (isRunning) {
                statusElement.textContent = '🟢 后台服务正常';
                statusElement.style.backgroundColor = 'var(--success-color)';
            } else {
                statusElement.textContent = '🔴 后台服务离线';
                statusElement.style.backgroundColor = 'var(--error-color)';
            }
        }

        /**
         * 显示后台服务启动指南
         */
        function showBackendStartupGuide() {
            const guideHtml = `
                <div style="max-width: 500px;">
                    <h4 style="color: var(--warning-color); margin-bottom: 15px; display: flex; align-items: center;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                        后台服务未启动
                    </h4>
                    <p style="margin-bottom: 15px; color: var(--text-secondary);">为了使用完整功能，请启动后台API服务：</p>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--primary-color);">
                        <h5 style="margin-bottom: 10px; color: var(--primary-color);">🚀 推荐方式：自动启动脚本</h5>
                        <code style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; display: block; margin-bottom: 10px; font-family: 'Monaco', 'Consolas', monospace;">
                            ./start-system.sh
                        </code>
                        
                        <h5 style="margin-bottom: 10px; color: var(--secondary-color);">⚙️ 手动启动方式</h5>
                        <code style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; display: block; font-family: 'Monaco', 'Consolas', monospace;">
                            cd backend && node simple-server.cjs
                        </code>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 4px solid var(--info-color);">
                        <p style="margin: 0; font-size: 14px; color: var(--info-color);">
                            <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                            启动后页面将自动检测并连接后台服务
                        </p>
                    </div>
                </div>
            `;
            
            showNotification(guideHtml, 'warning', 15000);
        }

        /**
         * 初始化后台服务检测
         */
        async function initializeBackendCheck() {
            console.log('🔍 检测后台服务状态...');
            const isRunning = await checkBackendService();
            showBackendStatus(isRunning);
            
            if (!isRunning) {
                console.log('⚠️ 后台服务未启动，显示启动指南');
                setTimeout(() => showBackendStartupGuide(), 1000);
            } else {
                 console.log('✅ 后台服务运行正常');
                 // 初始化其他功能模块
                 loadSystemStatus();
                 loadSyncStatus();
                 loadReplacementRules();
                 initializeHandwritingUpload();
                 loadSavedSettings();
             }
            
            // 定期检查服务状态
            setInterval(async () => {
                const currentStatus = await checkBackendService();
                showBackendStatus(currentStatus);
                
                // 如果服务从离线变为在线，重新加载数据
                 if (currentStatus && !window.lastBackendStatus) {
                     console.log('🔄 后台服务已恢复，重新加载数据...');
                     loadSystemStatus();
                     loadSyncStatus();
                     showNotification('后台服务已连接，数据已刷新', 'success');
                 }
                window.lastBackendStatus = currentStatus;
            }, 10000); // 每10秒检查一次
        }

        // 点击侧边栏导航项时在移动端关闭菜单
        document.addEventListener('DOMContentLoaded', function() {
            // 首先初始化后台服务检测
            initializeBackendCheck();
            
            // 设置移动端菜单功能
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        closeMobileMenu();
                    }
                });
            });
        });

        /**
         * 保存API设置
         */
        function saveAPISettings() {
            const settings = {
                cloudflareToken: document.getElementById('cloudflare-token').value,
                glmApiKey: document.getElementById('glm-api-key').value,
                telegramToken: document.getElementById('telegram-token').value,
                imageQuality: document.getElementById('image-quality').value,
                maxConcurrency: document.getElementById('max-concurrency').value,
                autoBackup: document.getElementById('auto-backup').value
            };
            
            localStorage.setItem('noteSystemSettings', JSON.stringify(settings));
            
            // 显示保存成功提示
            showNotification('设置已保存', 'success');
        }

        /**
         * 显示通知
         */
        function showNotification(message, type = 'info', duration = 3000) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1001;
                max-width: 500px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;
            
            switch(type) {
                case 'success':
                    notification.style.background = 'var(--success-color)';
                    break;
                case 'error':
                    notification.style.background = 'var(--error-color)';
                    break;
                case 'warning':
                    notification.style.background = 'var(--warning-color)';
                    notification.style.color = 'var(--text-primary)';
                    notification.style.background = '#fff3cd';
                    notification.style.border = '1px solid #ffeaa7';
                    break;
                default:
                    notification.style.background = 'var(--info-color)';
            }
            
            // 支持HTML内容
            if (message.includes('<')) {
                notification.innerHTML = message;
            } else {
                notification.textContent = message;
            }
            
            // 添加关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '×';
            closeBtn.style.cssText = `
                position: absolute;
                top: 8px;
                right: 12px;
                background: none;
                border: none;
                color: inherit;
                font-size: 20px;
                cursor: pointer;
                padding: 0;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            closeBtn.onclick = () => notification.remove();
            notification.appendChild(closeBtn);
            
            document.body.appendChild(notification);
            
            // 自动移除
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, duration);
            }
        }

        // 其他功能函数
        function refreshSystemStatus() {
            loadSystemStatus();
            showNotification('系统状态已刷新', 'success');
        }

        function triggerSync() {
            showNotification('同步已启动', 'info');
            // 实际的同步逻辑
        }

        function checkSyncStatus() {
            loadSyncStatus();
        }

        function startSync() {
            showNotification('同步已开始', 'success');
        }

        function pauseSync() {
            showNotification('同步已暂停', 'warning');
        }

        function clearSyncLog() {
            document.getElementById('sync-log').innerHTML = '';
            showNotification('同步日志已清空', 'info');
        }

        function addReplacementRule() {
            showNotification('添加替换规则功能开发中', 'info');
        }

        // 批量替换功能
        async function startBatchReplacement() {
            const notesPath = document.getElementById('notes-path').value;
            const sourcePattern = document.getElementById('source-pattern').value;
            const targetPattern = document.getElementById('target-pattern').value;
            const scope = document.getElementById('replacement-scope').value;
            
            if (!notesPath || !sourcePattern || !targetPattern) {
                showNotification('请填写完整的路径和模式信息', 'error');
                return;
            }
            
            showNotification('正在执行批量替换...', 'info');
            
            try {
                const response = await fetch('http://localhost:8787/api/batch-replace', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notesPath,
                        sourcePattern,
                        targetPattern,
                        scope
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`批量替换完成！处理了 ${result.processedFiles} 个文件，替换了 ${result.replacedLinks} 个链接`, 'success');
                    loadReplacementHistory(); // 刷新历史记录
                } else {
                    showNotification(`批量替换失败: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('批量替换错误:', error);
                showNotification('批量替换失败，请检查网络连接', 'error');
            }
        }
        
        // 加载替换历史记录
        async function loadReplacementHistory() {
            try {
                const response = await fetch('http://localhost:8787/api/replacement-history');
                const history = await response.json();
                
                const tbody = document.getElementById('replacement-history');
                tbody.innerHTML = '';
                
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">暂无替换历史记录</td></tr>';
                    return;
                }
                
                history.forEach(record => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--border-color)';
                    
                    const time = new Date(record.timestamp).toLocaleString('zh-CN');
                    const statusClass = record.status === 'success' ? 'status-success' : 'status-error';
                    const statusText = record.status === 'success' ? '成功' : '失败';
                    
                    row.innerHTML = `
                        <td style="padding: 1rem;">${time}</td>
                        <td style="padding: 1rem;">${record.fileName}</td>
                        <td style="padding: 1rem;">${record.fileSize}</td>
                        <td style="padding: 1rem;">
                            <span class="status-indicator ${statusClass}">
                                <div class="status-dot"></div>
                                ${statusText}
                            </span>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('加载替换历史失败:', error);
            }
        }

        function clearProcessingHistory() {
            document.getElementById('processing-history').innerHTML = '';
            showNotification('处理历史已清空', 'info');
        }

        function handleBatchFiles(files) {
            showNotification(`选择了 ${files.length} 个文件进行批量处理`, 'info');
        }

        function startBatchProcessing() {
            showNotification('批量处理已启动', 'info');
        }

        function testGitHubConnection() {
            showNotification('正在测试GitHub连接...', 'info');
        }

        function syncToGitHub() {
            showNotification('正在推送到GitHub...', 'info');
        }

        function pullFromGitHub() {
            showNotification('正在从GitHub拉取...', 'info');
        }

        function forceSync() {
            showNotification('强制同步已启动', 'warning');
        }

        function createAutomationTask() {
            showNotification('创建自动化任务功能开发中', 'info');
        }
        
        // GitHub状态管理
        async function refreshGitHubStatus() {
            try {
                showNotification('正在获取GitHub仓库状态...', 'info');
                
                // 获取GitHub仓库基本信息
                const repoResponse = await fetch('http://localhost:8787/api/github/repo-info');
                if (repoResponse.ok) {
                    const repoData = await repoResponse.json();
                    updateGitHubRepoInfo(repoData);
                }
                
                // 获取同步状态
                const syncResponse = await fetch('http://localhost:8787/api/sync/status');
                if (syncResponse.ok) {
                    const syncData = await syncResponse.json();
                    updateGitHubSyncInfo(syncData);
                }
                
                // 获取笔记更新情况
                const notesResponse = await fetch('http://localhost:8787/api/notes/updates');
                if (notesResponse.ok) {
                    const notesData = await notesResponse.json();
                    updateNotesInfo(notesData);
                }
                
                showNotification('GitHub状态已更新', 'success');
            } catch (error) {
                console.error('获取GitHub状态失败:', error);
                showNotification('获取GitHub状态失败: ' + error.message, 'error');
                updateGitHubStatusError();
            }
        }
        
        function updateGitHubRepoInfo(data) {
            const statusIndicator = document.getElementById('github-status-indicator');
            const statusText = document.getElementById('github-status-text');
            const currentBranch = document.getElementById('github-current-branch');
            const latestCommit = document.getElementById('github-latest-commit');
            const repoStatus = document.getElementById('github-repo-status');
            
            if (data.connected) {
                statusIndicator.className = 'status-indicator status-success';
                statusText.textContent = '已连接';
                currentBranch.textContent = data.currentBranch || 'main';
                latestCommit.textContent = data.latestCommit ? 
                    `${data.latestCommit.substring(0, 7)} - ${data.commitMessage || ''}` : '无';
                repoStatus.textContent = data.status || '正常';
            } else {
                statusIndicator.className = 'status-indicator status-error';
                statusText.textContent = '未连接';
                currentBranch.textContent = '未知';
                latestCommit.textContent = '无';
                repoStatus.textContent = '离线';
            }
        }
        
        function updateGitHubSyncInfo(data) {
            const lastSync = document.getElementById('github-last-sync');
            const syncFiles = document.getElementById('github-sync-files');
            
            if (data.lastSync) {
                const syncTime = new Date(data.lastSync);
                const now = new Date();
                const diffMinutes = Math.floor((now - syncTime) / (1000 * 60));
                
                if (diffMinutes < 1) {
                    lastSync.textContent = '刚刚';
                } else if (diffMinutes < 60) {
                    lastSync.textContent = `${diffMinutes}分钟前`;
                } else if (diffMinutes < 1440) {
                    const hours = Math.floor(diffMinutes / 60);
                    lastSync.textContent = `${hours}小时前`;
                } else {
                    lastSync.textContent = syncTime.toLocaleDateString('zh-CN') + ' ' + 
                        syncTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                }
            } else {
                lastSync.textContent = '从未同步';
            }
            
            syncFiles.textContent = `${data.syncedFiles || 0}个`;
        }
        
        function updateNotesInfo(data) {
            // 这里可以添加笔记更新情况的显示逻辑
            // 比如在侧边栏显示最近更新的笔记列表
            console.log('笔记更新情况:', data);
        }
        
        function updateGitHubStatusError() {
            const statusIndicator = document.getElementById('github-status-indicator');
            const statusText = document.getElementById('github-status-text');
            const lastSync = document.getElementById('github-last-sync');
            const syncFiles = document.getElementById('github-sync-files');
            const repoStatus = document.getElementById('github-repo-status');
            const currentBranch = document.getElementById('github-current-branch');
            const latestCommit = document.getElementById('github-latest-commit');
            
            statusIndicator.className = 'status-indicator status-error';
            statusText.textContent = '连接失败';
            lastSync.textContent = '获取失败';
            syncFiles.textContent = '获取失败';
            repoStatus.textContent = '获取失败';
            currentBranch.textContent = '获取失败';
            latestCommit.textContent = '获取失败';
        }
        
        // Gallery功能
        let galleryData = {
            images: [],
            currentPage: 1,
            pageSize: 20,
            totalPages: 1,
            currentFilter: 'all',
            searchQuery: ''
        };
        
        // 加载图片库
        async function loadGallery() {
            try {
                showNotification('正在加载图片库...', 'info');
                const response = await fetch('http://localhost:8787/api/gallery/images');
                if (response.ok) {
                    const data = await response.json();
                    galleryData.images = data.images || [];
                    updateGalleryStats({
                        total: data.total || 0,
                        totalSize: data.totalSize || 0,
                        recentUploads: data.images ? data.images.filter(img => {
                            const uploadDate = new Date(img.uploadDate);
                            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                            return uploadDate > weekAgo;
                        }).length : 0
                    });
                    filterAndDisplayImages();
                    showNotification('图片库加载完成', 'success');
                } else {
                    throw new Error('加载图片库失败');
                }
            } catch (error) {
                console.error('加载图片库失败:', error);
                showNotification('加载图片库失败: ' + error.message, 'error');
                displayGalleryError();
            }
        }
        
        // 更新图片统计
        function updateGalleryStats(stats) {
            // 检查Gallery页面是否可见
            const galleryPage = document.getElementById('gallery-page');
            if (!galleryPage || galleryPage.classList.contains('hidden')) {
                return; // Gallery页面不可见时不更新统计
            }
            
            const totalImagesEl = document.getElementById('total-images');
            const totalSizeEl = document.getElementById('total-size');
            const todayUploadsEl = document.getElementById('today-uploads');
            
            if (totalImagesEl) totalImagesEl.textContent = stats?.total || 0;
            if (totalSizeEl) totalSizeEl.textContent = formatFileSize(stats?.totalSize || 0);
            if (todayUploadsEl) todayUploadsEl.textContent = stats?.recentUploads || 0;
        }
        
        // 筛选和显示图片
        function filterAndDisplayImages() {
            let filteredImages = galleryData.images;
            
            // 应用筛选器
            if (galleryData.currentFilter !== 'all') {
                const now = new Date();
                const filterDate = new Date();
                
                switch (galleryData.currentFilter) {
                    case 'today':
                        filterDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        filterDate.setDate(filterDate.getDate() - 7);
                        break;
                    case 'month':
                        filterDate.setMonth(filterDate.getMonth() - 1);
                        break;
                }
                
                if (galleryData.currentFilter !== 'all') {
                    filteredImages = filteredImages.filter(img => 
                        new Date(img.uploadDate || img.uploadTime) >= filterDate
                    );
                }
            }
            
            // 应用搜索
            if (galleryData.searchQuery) {
                const query = galleryData.searchQuery.toLowerCase();
                filteredImages = filteredImages.filter(img => 
                    (img.filename || img.name || '').toLowerCase().includes(query) ||
                    (img.tags && img.tags.some(tag => tag.toLowerCase().includes(query)))
                );
            }
            
            // 计算分页
            galleryData.totalPages = Math.ceil(filteredImages.length / galleryData.pageSize);
            const startIndex = (galleryData.currentPage - 1) * galleryData.pageSize;
            const endIndex = startIndex + galleryData.pageSize;
            const pageImages = filteredImages.slice(startIndex, endIndex);
            
            displayImages(pageImages);
            updatePagination(filteredImages.length);
        }
        
        // 显示图片
        function displayImages(images) {
            const container = document.getElementById('gallery-grid');
            
            if (images.length === 0) {
                container.innerHTML = `
                    <div class="gallery-loading">
                        <i class="fas fa-images"></i>
                        <p>没有找到图片</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = images.map(img => `
                <div class="gallery-item" onclick="previewImage('${img.url}', '${img.filename || img.name}', '${img.size}', '${img.uploadDate || img.uploadTime}')">
                    <img src="${img.thumbnail || img.url}" alt="${img.filename || img.name}" loading="lazy">
                    <div class="gallery-item-info">
                        <div class="gallery-item-name" title="${img.filename || img.name}">${img.filename || img.name}</div>
                        <div class="gallery-item-meta">
                            <span>${formatFileSize(img.size)}</span>
                            <span>${formatDate(img.uploadDate || img.uploadTime)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 显示加载错误
        function displayGalleryError() {
            const container = document.getElementById('gallery-grid');
            container.innerHTML = `
                <div class="gallery-loading">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>加载图片库失败</p>
                    <button class="btn btn-primary" onclick="loadGallery()">重试</button>
                </div>
            `;
        }
        
        // 更新分页
        function updatePagination(totalItems) {
            const pagination = document.querySelector('.gallery-pagination');
            const pageInfo = `第 ${galleryData.currentPage} 页，共 ${galleryData.totalPages} 页 (${totalItems} 张图片)`;
            
            pagination.innerHTML = `
                <div>
                    <button class="btn btn-secondary" onclick="changePage(-1)" 
                            ${galleryData.currentPage <= 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i> 上一页
                    </button>
                    <span style="margin: 0 1rem;">${pageInfo}</span>
                    <button class="btn btn-secondary" onclick="changePage(1)" 
                            ${galleryData.currentPage >= galleryData.totalPages ? 'disabled' : ''}>
                        下一页 <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;
        }
        
        // 切换页面
        function changePage(direction) {
            const newPage = galleryData.currentPage + direction;
            if (newPage >= 1 && newPage <= galleryData.totalPages) {
                galleryData.currentPage = newPage;
                filterAndDisplayImages();
            }
        }
        
        // 加载图片库页面
        function loadGalleryPage(direction) {
            if (direction === 'prev') {
                changePage(-1);
            } else if (direction === 'next') {
                changePage(1);
            }
        }
        
        // 应用筛选器
        function applyGalleryFilter() {
            const filterSelect = document.getElementById('gallery-filter');
            galleryData.currentFilter = filterSelect.value;
            galleryData.currentPage = 1;
            filterAndDisplayImages();
        }
        
        // 搜索图片
        function searchGallery() {
            const searchInput = document.getElementById('gallery-search');
            galleryData.searchQuery = searchInput.value.trim();
            galleryData.currentPage = 1;
            filterAndDisplayImages();
        }
        
        // 筛选图片库
        function filterGallery() {
            applyGalleryFilter();
        }
        
        // 刷新图片库统计
        async function refreshGalleryStats() {
            try {
                showNotification('正在刷新统计...', 'info');
                await loadGallery();
                showNotification('统计刷新完成', 'success');
            } catch (error) {
                console.error('刷新统计失败:', error);
                showNotification('刷新统计失败: ' + error.message, 'error');
            }
        }
        
        // 清理图片库（别名函数）
        async function cleanupGallery() {
            await cleanInvalidImages();
        }
        
        // 导出图片库列表（别名函数）
        async function exportGalleryList() {
            await exportImageList();
        }
        
        // 预览图片
        function previewImage(url, name, size, uploadTime) {
            const modal = document.getElementById('image-modal');
            const img = modal.querySelector('img');
            const info = modal.querySelector('.image-modal-info');
            
            img.src = url;
            info.innerHTML = `
                <div><strong>${name}</strong></div>
                <div>大小: ${formatFileSize(size)} | 上传时间: ${formatDate(uploadTime)}</div>
            `;
            
            modal.classList.add('show');
        }
        
        // 关闭图片预览
        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('show');
        }
        
        // 上传新图片
        function uploadNewImage() {
            showNotification('上传功能开发中', 'info');
        }
        
        // 清理无效图片
        async function cleanInvalidImages() {
            try {
                showNotification('正在清理无效图片...', 'info');
                const response = await fetch('http://localhost:8787/api/gallery/clean', { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`清理完成，删除了 ${result.deletedCount} 张无效图片`, 'success');
                    loadGallery(); // 重新加载
                } else {
                    throw new Error('清理失败');
                }
            } catch (error) {
                console.error('清理无效图片失败:', error);
                showNotification('清理失败: ' + error.message, 'error');
            }
        }
        
        // 导出图片列表
        async function exportImageList() {
            try {
                showNotification('正在导出图片列表...', 'info');
                const response = await fetch('http://localhost:8787/api/gallery/export');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `image-list-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showNotification('图片列表导出成功', 'success');
                } else {
                    throw new Error('导出失败');
                }
            } catch (error) {
                console.error('导出图片列表失败:', error);
                showNotification('导出失败: ' + error.message, 'error');
            }
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = now - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return '今天';
            } else if (diffDays === 1) {
                return '昨天';
            } else if (diffDays < 7) {
                return `${diffDays}天前`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }
        
        // 快捷键支持
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                // Ctrl+Shift+R (Windows/Linux) 或 Cmd+Shift+R (Mac)
                if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'R') {
                    event.preventDefault();
                    startBatchReplacement();
                }
                
                // ESC键关闭图片预览
                if (event.key === 'Escape') {
                    closeImageModal();
                }
            });
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupKeyboardShortcuts();
            loadReplacementHistory();
            refreshGitHubStatus();
            
            // 只在用户访问Gallery页面时加载
            if (window.location.hash === '#gallery') {
                setTimeout(() => {
                    showPage('gallery');
                    loadGallery();
                }, 100);
            }
        });
    </script>
    
    <!-- 图片预览模态框 -->
    <div id="image-modal" class="image-modal" onclick="closeImageModal()">
        <div class="image-modal-content" onclick="event.stopPropagation()">
            <button class="image-modal-close" onclick="closeImageModal()">
                <i class="fas fa-times"></i>
            </button>
            <img src="" alt="预览图片">
            <div class="image-modal-info"></div>
        </div>
    </div>
</body>
</html>