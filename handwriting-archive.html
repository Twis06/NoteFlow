<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手写识别与归档系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background-color: #f7fafc;
        }

        .upload-area i {
            font-size: 3rem;
            color: #a0aec0;
            margin-bottom: 15px;
        }

        .upload-area.dragover i {
            color: #667eea;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #718096;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #a0aec0;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #68d391 0%, #48bb78 100%);
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: #edf2f7;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-name {
            font-weight: 500;
            color: #2d3748;
        }

        .file-size {
            font-size: 0.9rem;
            color: #718096;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }

        .status-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 500;
            color: #4a5568;
        }

        .status-value {
            font-weight: 600;
            color: #2d3748;
        }

        .status-success {
            color: #48bb78;
        }

        .status-error {
            color: #f56565;
        }

        .status-warning {
            color: #ed8936;
        }

        .log-panel {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #a0aec0;
            margin-right: 10px;
        }

        .log-info {
            color: #63b3ed;
        }

        .log-success {
            color: #68d391;
        }

        .log-error {
            color: #fc8181;
        }

        .log-warning {
            color: #fbd38d;
        }

        .settings-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-checkbox {
            margin-right: 8px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #ebf8ff;
            color: #2b6cb0;
            border-left: 4px solid #3182ce;
        }

        .alert-success {
            background: #f0fff4;
            color: #276749;
            border-left: 4px solid #38a169;
        }

        .alert-warning {
            background: #fffbeb;
            color: #b7791f;
            border-left: 4px solid #d69e2e;
        }

        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border-left: 4px solid #e53e3e;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #a0aec0;
        }

        .modal-close:hover {
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-pen-fancy"></i> 手写识别与归档系统</h1>
            <p>批量上传手写笔记，自动OCR识别，整理成Markdown并同步到GitHub</p>
        </div>

        <div class="main-content">
            <!-- 上传区域 -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-cloud-upload-alt"></i>
                    批量上传图片
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-images"></i>
                    <div class="upload-text">拖拽图片到此处或点击选择</div>
                    <div class="upload-hint">支持 JPG, PNG, WEBP 格式，最大 10MB</div>
                </div>
                
                <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
                
                <div class="form-group">
                    <button class="btn" id="selectFilesBtn">
                        <i class="fas fa-folder-open"></i>
                        选择文件
                    </button>
                    <button class="btn btn-secondary" id="clearFilesBtn">
                        <i class="fas fa-trash"></i>
                        清空列表
                    </button>
                </div>
                
                <div class="file-list" id="fileList"></div>
            </div>

            <!-- 处理控制 -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-cogs"></i>
                    处理控制
                </div>
                
                <div class="form-group">
                    <label class="form-label">处理选项</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label>
                            <input type="checkbox" class="form-checkbox" id="enableOCR" checked>
                            启用OCR识别
                        </label>
                        <label>
                            <input type="checkbox" class="form-checkbox" id="enableBackup" checked>
                            启用GitHub备份
                        </label>
                        <label>
                            <input type="checkbox" class="form-checkbox" id="autoSync" checked>
                            完成后自动同步本地
                        </label>
                        <label>
                            <input type="checkbox" class="form-checkbox" id="safeMode" checked>
                            安全模式（版本冲突时创建新分支）
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="notesTitle">笔记标题</label>
                    <input type="text" class="form-input" id="notesTitle" placeholder="手写笔记 - 自动生成">
                </div>
                
                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-success" id="startProcessBtn" disabled>
                        <i class="fas fa-play"></i>
                        开始处理
                    </button>
                    <button class="btn btn-danger" id="stopProcessBtn" style="display: none;">
                        <i class="fas fa-stop"></i>
                        停止处理
                    </button>
                </div>
            </div>
        </div>

        <!-- 状态面板 -->
        <div class="status-panel">
            <div class="card-title">
                <i class="fas fa-chart-line"></i>
                处理状态
            </div>
            
            <div class="status-item">
                <span class="status-label">已选择文件</span>
                <span class="status-value" id="selectedCount">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">处理进度</span>
                <span class="status-value" id="processProgress">0/0</span>
            </div>
            <div class="status-item">
                <span class="status-label">OCR识别</span>
                <span class="status-value" id="ocrStatus">待开始</span>
            </div>
            <div class="status-item">
                <span class="status-label">Markdown生成</span>
                <span class="status-value" id="markdownStatus">待开始</span>
            </div>
            <div class="status-item">
                <span class="status-label">GitHub同步</span>
                <span class="status-value" id="githubStatus">待开始</span>
            </div>
            <div class="status-item">
                <span class="status-label">本地同步</span>
                <span class="status-value" id="localSyncStatus">待开始</span>
            </div>
        </div>

        <!-- 设置面板 -->
        <div class="settings-panel">
            <div class="card-title">
                <i class="fas fa-sliders-h"></i>
                高级设置
            </div>
            
            <div class="form-group">
                <label class="form-label" for="localNotesPath">本地笔记路径</label>
                <input type="text" class="form-input" id="localNotesPath" value="/Users/lipeiyang/Documents/notes">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="githubRepo">GitHub仓库</label>
                <input type="text" class="form-input" id="githubRepo" value="Twis06/notes" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="branchName">目标分支</label>
                <input type="text" class="form-input" id="branchName" value="main">
            </div>
            
            <div class="form-group">
                <button class="btn btn-secondary" id="testConnectionBtn">
                    <i class="fas fa-plug"></i>
                    测试连接
                </button>
                <button class="btn btn-secondary" id="viewLogsBtn">
                    <i class="fas fa-file-alt"></i>
                    查看日志
                </button>
            </div>
        </div>

        <!-- 日志面板 -->
        <div class="log-panel" id="logPanel" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span style="color: #e2e8f0; font-weight: 600;">处理日志</span>
                <button class="btn btn-secondary" id="clearLogsBtn" style="padding: 5px 10px; font-size: 0.8rem;">
                    <i class="fas fa-trash"></i>
                    清空
                </button>
            </div>
            <div id="logContent"></div>
        </div>
    </div>

    <!-- 预览模态框 -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Markdown预览</div>
                <button class="modal-close" id="closePreviewBtn">&times;</button>
            </div>
            <div id="previewContent"></div>
        </div>
    </div>

    <script>
        /**
         * 手写识别与归档系统主类
         * 负责文件上传、OCR处理、Markdown生成和GitHub同步
         */
        class HandwritingArchiveSystem {
            constructor() {
                this.selectedFiles = [];
                this.isProcessing = false;
                this.processedCount = 0;
                this.totalCount = 0;
                this.apiBaseUrl = 'http://localhost:8788';
                
                this.initializeElements();
                this.bindEvents();
                this.loadSettings();
            }

            /**
             * 初始化DOM元素引用
             */
            initializeElements() {
                // 上传相关
                this.uploadArea = document.getElementById('uploadArea');
                this.fileInput = document.getElementById('fileInput');
                this.fileList = document.getElementById('fileList');
                this.selectFilesBtn = document.getElementById('selectFilesBtn');
                this.clearFilesBtn = document.getElementById('clearFilesBtn');
                
                // 处理控制
                this.startProcessBtn = document.getElementById('startProcessBtn');
                this.stopProcessBtn = document.getElementById('stopProcessBtn');
                this.progressBar = document.getElementById('progressBar');
                this.progressFill = document.getElementById('progressFill');
                
                // 状态显示
                this.selectedCount = document.getElementById('selectedCount');
                this.processProgress = document.getElementById('processProgress');
                this.ocrStatus = document.getElementById('ocrStatus');
                this.markdownStatus = document.getElementById('markdownStatus');
                this.githubStatus = document.getElementById('githubStatus');
                this.localSyncStatus = document.getElementById('localSyncStatus');
                
                // 设置
                this.localNotesPath = document.getElementById('localNotesPath');
                this.githubRepo = document.getElementById('githubRepo');
                this.branchName = document.getElementById('branchName');
                this.notesTitle = document.getElementById('notesTitle');
                
                // 选项
                this.enableOCR = document.getElementById('enableOCR');
                this.enableBackup = document.getElementById('enableBackup');
                this.autoSync = document.getElementById('autoSync');
                this.safeMode = document.getElementById('safeMode');
                
                // 日志
                this.logPanel = document.getElementById('logPanel');
                this.logContent = document.getElementById('logContent');
                this.viewLogsBtn = document.getElementById('viewLogsBtn');
                this.clearLogsBtn = document.getElementById('clearLogsBtn');
                
                // 其他
                this.testConnectionBtn = document.getElementById('testConnectionBtn');
                this.previewModal = document.getElementById('previewModal');
                this.closePreviewBtn = document.getElementById('closePreviewBtn');
            }

            /**
             * 绑定事件监听器
             */
            bindEvents() {
                // 文件上传事件
                this.uploadArea.addEventListener('click', () => this.fileInput.click());
                this.uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                this.uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
                this.uploadArea.addEventListener('drop', this.handleDrop.bind(this));
                
                this.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
                this.selectFilesBtn.addEventListener('click', () => this.fileInput.click());
                this.clearFilesBtn.addEventListener('click', this.clearFiles.bind(this));
                
                // 处理控制事件
                this.startProcessBtn.addEventListener('click', this.startProcessing.bind(this));
                this.stopProcessBtn.addEventListener('click', this.stopProcessing.bind(this));
                
                // 设置事件
                this.testConnectionBtn.addEventListener('click', this.testConnection.bind(this));
                this.viewLogsBtn.addEventListener('click', this.toggleLogs.bind(this));
                this.clearLogsBtn.addEventListener('click', this.clearLogs.bind(this));
                
                // 模态框事件
                this.closePreviewBtn.addEventListener('click', this.closePreview.bind(this));
                this.previewModal.addEventListener('click', (e) => {
                    if (e.target === this.previewModal) this.closePreview();
                });
                
                // 自动保存设置
                [this.localNotesPath, this.branchName, this.notesTitle].forEach(input => {
                    input.addEventListener('change', this.saveSettings.bind(this));
                });
                
                [this.enableOCR, this.enableBackup, this.autoSync, this.safeMode].forEach(checkbox => {
                    checkbox.addEventListener('change', this.saveSettings.bind(this));
                });
            }

            /**
             * 处理拖拽悬停
             */
            handleDragOver(e) {
                e.preventDefault();
                this.uploadArea.classList.add('dragover');
            }

            /**
             * 处理拖拽离开
             */
            handleDragLeave(e) {
                e.preventDefault();
                this.uploadArea.classList.remove('dragover');
            }

            /**
             * 处理文件拖拽放置
             */
            handleDrop(e) {
                e.preventDefault();
                this.uploadArea.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type.startsWith('image/')
                );
                
                this.addFiles(files);
            }

            /**
             * 处理文件选择
             */
            handleFileSelect(e) {
                const files = Array.from(e.target.files);
                this.addFiles(files);
            }

            /**
             * 添加文件到列表
             */
            addFiles(files) {
                files.forEach(file => {
                    if (!this.selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                        this.selectedFiles.push(file);
                    }
                });
                
                this.updateFileList();
                this.updateStatus();
            }

            /**
             * 更新文件列表显示
             */
            updateFileList() {
                this.fileList.innerHTML = '';
                
                this.selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <i class="fas fa-image"></i>
                            <div>
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${this.formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-secondary" onclick="archiveSystem.removeFile(${index})" style="padding: 5px 10px; font-size: 0.8rem;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    this.fileList.appendChild(fileItem);
                });
            }

            /**
             * 移除文件
             */
            removeFile(index) {
                this.selectedFiles.splice(index, 1);
                this.updateFileList();
                this.updateStatus();
            }

            /**
             * 清空文件列表
             */
            clearFiles() {
                this.selectedFiles = [];
                this.updateFileList();
                this.updateStatus();
            }

            /**
             * 更新状态显示
             */
            updateStatus() {
                this.selectedCount.textContent = this.selectedFiles.length;
                this.processProgress.textContent = `${this.processedCount}/${this.totalCount}`;
                
                // 更新开始按钮状态
                this.startProcessBtn.disabled = this.selectedFiles.length === 0 || this.isProcessing;
            }

            /**
             * 开始处理
             */
            async startProcessing() {
                if (this.selectedFiles.length === 0) {
                    this.showAlert('请先选择要处理的图片文件', 'warning');
                    return;
                }
                
                this.isProcessing = true;
                this.processedCount = 0;
                this.totalCount = this.selectedFiles.length;
                
                this.startProcessBtn.style.display = 'none';
                this.stopProcessBtn.style.display = 'inline-flex';
                this.progressBar.style.display = 'block';
                
                this.updateStatus();
                this.log('开始处理手写笔记...', 'info');
                
                try {
                    // 1. 上传图片到Cloudflare Images
                    this.ocrStatus.textContent = '上传中...';
                    this.ocrStatus.className = 'status-value status-warning';
                    
                    const uploadedImages = await this.uploadImages();
                    
                    // 2. OCR识别
                    if (this.enableOCR.checked) {
                        this.ocrStatus.textContent = '识别中...';
                        const ocrResults = await this.performOCR(uploadedImages);
                        this.ocrStatus.textContent = '完成';
                        this.ocrStatus.className = 'status-value status-success';
                        
                        // 3. 生成Markdown
                        this.markdownStatus.textContent = '生成中...';
                        this.markdownStatus.className = 'status-value status-warning';
                        
                        const markdownContent = await this.generateMarkdown(uploadedImages, ocrResults);
                        this.markdownStatus.textContent = '完成';
                        this.markdownStatus.className = 'status-value status-success';
                        
                        // 4. 保存到GitHub
                        if (this.enableBackup.checked) {
                            this.githubStatus.textContent = '同步中...';
                            this.githubStatus.className = 'status-value status-warning';
                            
                            await this.saveToGitHub(markdownContent);
                            this.githubStatus.textContent = '完成';
                            this.githubStatus.className = 'status-value status-success';
                        }
                        
                        // 5. 本地同步
                        if (this.autoSync.checked) {
                            this.localSyncStatus.textContent = '同步中...';
                            this.localSyncStatus.className = 'status-value status-warning';
                            
                            await this.syncLocal();
                            this.localSyncStatus.textContent = '完成';
                            this.localSyncStatus.className = 'status-value status-success';
                        }
                    }
                    
                    this.log('所有处理完成！', 'success');
                    this.showAlert('手写笔记处理完成！', 'success');
                    
                } catch (error) {
                    this.log(`处理失败: ${error.message}`, 'error');
                    this.showAlert(`处理失败: ${error.message}`, 'error');
                } finally {
                    this.finishProcessing();
                }
            }

            /**
             * 上传图片到Cloudflare Images
             */
            async uploadImages() {
                const uploadedImages = [];
                
                for (let i = 0; i < this.selectedFiles.length; i++) {
                    const file = this.selectedFiles[i];
                    this.log(`上传图片: ${file.name}`, 'info');
                    
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const response = await fetch(`${this.apiBaseUrl}/api/upload-image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`上传失败: ${file.name}`);
                    }
                    
                    const result = await response.json();
                    uploadedImages.push({
                        id: result.id,
                        url: result.url,
                        filename: file.name,
                        size: file.size
                    });
                    
                    this.processedCount++;
                    this.updateProgress();
                }
                
                return uploadedImages;
            }

            /**
             * 执行OCR识别
             */
            async performOCR(images) {
                this.log('开始OCR识别...', 'info');
                
                const imageUrls = images.map(img => img.url);
                
                const response = await fetch(`${this.apiBaseUrl}/api/batch-ocr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageUrls,
                        options: {
                            enableOCR: true,
                            includeImages: true,
                            includeMetadata: true
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error('OCR识别失败');
                }
                
                const result = await response.json();
                this.log(`OCR识别完成，识别了 ${result.results.length} 张图片`, 'success');
                
                return result.results;
            }

            /**
             * 生成Markdown内容
             */
            async generateMarkdown(images, ocrResults) {
                const title = this.notesTitle.value || `手写笔记 - ${new Date().toLocaleDateString('zh-CN')}`;
                
                let markdown = `# ${title}\n\n`;
                markdown += `> **生成时间**: ${new Date().toLocaleString('zh-CN')}\n`;
                markdown += `> **处理图片数量**: ${images.length}\n\n`;
                markdown += '---\n\n';
                
                ocrResults.forEach((result, index) => {
                    const image = images[index];
                    markdown += `## 第 ${index + 1} 页 - ${image.filename}\n\n`;
                    markdown += `![${image.filename}](${image.url})\n\n`;
                    
                    if (result.text) {
                        markdown += `${result.text}\n\n`;
                    } else {
                        markdown += '*此页面未识别到文字内容*\n\n';
                    }
                    
                    markdown += '---\n\n';
                });
                
                markdown += `\n\n*本文档由手写识别与归档系统自动生成*`;
                
                this.log('Markdown内容生成完成', 'success');
                return markdown;
            }

            /**
             * 保存到GitHub
             */
            async saveToGitHub(markdownContent) {
                this.log('保存到GitHub...', 'info');
                
                // 生成精确到分钟的文件名，避免同一天内的文件被覆盖
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 16).replace('T', '_').replace(/:/g, '-'); // YYYY-MM-DD_HH-MM
                const filename = `handwritten-notes-${dateStr}.md`;
                
                const response = await fetch(`${this.apiBaseUrl}/api/github/save-note`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename,
                        content: markdownContent,
                        branch: this.branchName.value,
                        safeMode: this.safeMode.checked,
                        commitMessage: `Add handwritten notes: ${filename}`
                    })
                });
                
                if (!response.ok) {
                    throw new Error('GitHub保存失败');
                }
                
                const result = await response.json();
                this.log(`已保存到GitHub: ${result.path}`, 'success');
            }

            /**
             * 本地同步
             */
            async syncLocal() {
                this.log('开始本地同步...', 'info');
                
                const response = await fetch(`${this.apiBaseUrl}/api/sync/local`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        localPath: this.localNotesPath.value,
                        branch: this.branchName.value,
                        safeMode: this.safeMode.checked
                    })
                });
                
                if (!response.ok) {
                    throw new Error('本地同步失败');
                }
                
                const result = await response.json();
                this.log('本地同步完成', 'success');
            }

            /**
             * 停止处理
             */
            stopProcessing() {
                this.isProcessing = false;
                this.log('用户停止了处理', 'warning');
                this.finishProcessing();
            }

            /**
             * 完成处理
             */
            finishProcessing() {
                this.isProcessing = false;
                this.startProcessBtn.style.display = 'inline-flex';
                this.stopProcessBtn.style.display = 'none';
                this.progressBar.style.display = 'none';
                this.updateStatus();
            }

            /**
             * 更新进度条
             */
            updateProgress() {
                const progress = (this.processedCount / this.totalCount) * 100;
                this.progressFill.style.width = `${progress}%`;
                this.updateStatus();
            }

            /**
             * 测试连接
             */
            async testConnection() {
                this.log('测试API连接...', 'info');
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/stats`);
                    if (response.ok) {
                        this.log('API连接正常', 'success');
                        this.showAlert('API连接正常', 'success');
                    } else {
                        throw new Error('API响应异常');
                    }
                } catch (error) {
                    this.log(`连接测试失败: ${error.message}`, 'error');
                    this.showAlert(`连接测试失败: ${error.message}`, 'error');
                }
            }

            /**
             * 切换日志显示
             */
            toggleLogs() {
                const isVisible = this.logPanel.style.display !== 'none';
                this.logPanel.style.display = isVisible ? 'none' : 'block';
                this.viewLogsBtn.innerHTML = isVisible ? 
                    '<i class="fas fa-file-alt"></i> 查看日志' : 
                    '<i class="fas fa-eye-slash"></i> 隐藏日志';
            }

            /**
             * 清空日志
             */
            clearLogs() {
                this.logContent.innerHTML = '';
            }

            /**
             * 添加日志
             */
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('zh-CN');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span>${message}`;
                
                this.logContent.appendChild(logEntry);
                this.logContent.scrollTop = this.logContent.scrollHeight;
                
                console.log(`[${type.toUpperCase()}] ${message}`);
            }

            /**
             * 显示提示
             */
            showAlert(message, type = 'info') {
                // 创建提示元素
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    <i class="fas fa-${this.getAlertIcon(type)}"></i>
                    <div>${message}</div>
                `;
                
                // 插入到页面顶部
                document.body.insertBefore(alert, document.body.firstChild);
                
                // 3秒后自动移除
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 3000);
            }

            /**
             * 获取提示图标
             */
            getAlertIcon(type) {
                const icons = {
                    info: 'info-circle',
                    success: 'check-circle',
                    warning: 'exclamation-triangle',
                    error: 'times-circle'
                };
                return icons[type] || 'info-circle';
            }

            /**
             * 关闭预览
             */
            closePreview() {
                this.previewModal.style.display = 'none';
            }

            /**
             * 格式化文件大小
             */
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            /**
             * 保存设置
             */
            saveSettings() {
                const settings = {
                    localNotesPath: this.localNotesPath.value,
                    branchName: this.branchName.value,
                    notesTitle: this.notesTitle.value,
                    enableOCR: this.enableOCR.checked,
                    enableBackup: this.enableBackup.checked,
                    autoSync: this.autoSync.checked,
                    safeMode: this.safeMode.checked
                };
                
                localStorage.setItem('handwritingArchiveSettings', JSON.stringify(settings));
            }

            /**
             * 加载设置
             */
            loadSettings() {
                const saved = localStorage.getItem('handwritingArchiveSettings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    
                    this.localNotesPath.value = settings.localNotesPath || '/Users/lipeiyang/Documents/notes';
                    this.branchName.value = settings.branchName || 'main';
                    this.notesTitle.value = settings.notesTitle || '';
                    this.enableOCR.checked = settings.enableOCR !== false;
                    this.enableBackup.checked = settings.enableBackup !== false;
                    this.autoSync.checked = settings.autoSync !== false;
                    this.safeMode.checked = settings.safeMode !== false;
                }
            }
        }

        // 初始化系统
        const archiveSystem = new HandwritingArchiveSystem();
    </script>
</body>
</html>